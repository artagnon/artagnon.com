<!DOCTYPE html>
<html>
  <head>
    <title>Inside a register allocator | artagnon.com</title>
    <meta charset="utf-8" />
    <meta name="language" content="english" />
    <meta name="author" content="Ramkumar Ramachandra" />
    <meta name="city" content="Paris" />
    <meta name="country" content="France" />
    <meta name="keywords" content="mathematics, mathematical notes, study notes, programming, blog, personal website" />
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index,follow" />
    <link rel="icon" href="/dist/favicon.ico" />
    <link rel="stylesheet" href="/dist/style.min.css" />
    <script src="//ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
    <script>
      WebFont.load({
        google: {
          families: ['Josefin Sans', 'Roboto Mono']
        }
      });
    </script>
    <script defer="" src="//cdnjs.cloudflare.com/ajax/libs/cash/6.0.1/cash.min.js"></script>
    <script defer="" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script defer="" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
      extensions: ["tex2jax.js"], jax: ["input/TeX","output/HTML-CSS"],
      "HTML-CSS": { styles: {".MathJax_Preview": {visibility: "hidden"}} },
      tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
      TeX: {extensions: ["/dist/xypic.min.js","AMSmath.js","AMSsymbols.js"]} });
    </script>
    <link rel="preload" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/solarized-light.min.css" as="style" onload="this.onload=null;this.rel=&#39;stylesheet&#39;" />
    <noscript>
      <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/solarized-light.min.css" />
    </noscript>
    <script defer="" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
    <script defer="" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/coq.min.js"></script>
    <script defer="" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/cpp.min.js"></script>
    <script defer="" src="/dist/script.min.js"></script>
  </head>
  <body>
    <div id="wrapper">
      <main tabindex="0">
        <header>
          <h1>
            Inside a register allocator
          </h1>
          <div id="metadata">
            <span id="timestamp"><time datetime="2016-03-24" class="begin">Thu, 24 Mar 2016 17:36:35 -0500</time><span class="to">â†ª</span><time datetime="2019-12-13" class="end">Fri, 13 Dec 2019 20:08:46 +0100</time></span><br /><span id="locations"><address>Paris, Chennai, Boston</address></span>
          </div>
        </header>
        <article>
          <p>
            We are going to be discussing LLVM's Fast Register Allocator: you might like to open [RegAllocFast.cpp](https://github.com/llvm-mirror/llvm/blob/master/lib/CodeGen/RegAllocFast.cpp) and refer to it as we go through the article.
          </p>
          <p>
            FastRegAlloc allocates linearly, going through instructions and their operands in order. It uses `PhysRegState` to keep track of the state of various physical registers: they can be 0 (`regDisabled`), 1 (`regFree`), 2 (`regReserved`), or a virtual register number (a large number). At the time of allocation, the full UseDef information is available (so you have information like `LR.LastUse`); a register can either be a `&lt;def&gt;` or a use. If `IsImplicit` is flipped, it could also be a implicit-def (`&lt;imp-def&gt;`) or implicit-use (`&lt;imp-use&gt;`).
          </p>
          <pre><code class="language-cpp">%vreg349<def> = MOVZX32rm8 %vreg351, 1, %noreg, 0, %noreg</code></pre>
          <p>
            turns into
          </p>
          <pre><code class="language-cpp">%ESI<def> = MOVZX32rm8 %RDX<kill>, 1, %noreg, 0, %noreg</code></pre>
          <p>
            after allocation. The `&lt;kill&gt;` indicates that the instruction is the last use of `%RDX`. In another example,
          </p>
          <pre><code class="language-cpp">CQO %RAX<imp-def>, %RDX<imp-def>, %RAX<imp-use></code></pre>
          <p>
            turns into
          </p>
          <pre><code class="language-cpp">CQO %RAX<imp-def>, %RDX<imp-def>, %RAX<imp-use,kill></code></pre>
          <p>
            Notice that the instruction references physical registers even before the allocation. That's because this instruction specifically wants to sign extend `%RAX` into `%RDX` (not any other register) for use in a later `IDIV`. Remember that `IDIV` operates on `%RDX:%RAX` as the numerator, and writes the quotient in `%RAX`, reminder in `%RDX`.
          </p>
          <p>
            The instruction is modeled as `MachineInstr`, and the operands as `MachineOperand`. Note that a `MO` doesn't have to be a register: it could also be an immediate value; we use `MO.isReg()` to find out if it's a register, physical or virtual. In addition to the states shown in the pretty-print, `MO` can also be `EarlyClobber`, `Dead`, or `Undef`. A Dead `MO` implies Def, and<br/>
            indicates that the value defined is used no longer.
          </p>
          <p>
            `AllocateBasicBlock`, which operates on `MachineBasicBlock`, can be separated into three different scans, that operate on register MOs. Before the first scan, we set up the `LiveIns` (registers coming in live from the previous `MBB`) as `regReserved` so they aren't clobbered. The first scan operates on physical registers that are allocatable Uses; it calls `usePhysReg` on them. At this stage, the physical register must be either `regDisabled`, `regReserved`, or `regFree`. It cannot be allocated to a virtual register. Why? Imagine you see:
          </p>
          <pre><code class="language-cpp">CQO %RAX<imp-def>, %RDX<imp-def>, %RAX<imp-use></code></pre>
          <p>
            Now, if `%RAX` were already allocated to a virtual register, we're basically screwed in this linear walk. Otherwise, kill it, mark it as `regFree`, and move on: we have done our part by completing the use of the register that was reserved earlier.
          </p>
          <p>
            The second scan operates only on virtual register Uses. We add the register to `LiveVirtRegs`, via `reloadVirtReg`. If it didn't already exist in the map, we `allocVirtReg` it, which essentially gets the first `regFree` register not used in an instruction, and calls `assignVirtToPhysReg` on it. `assignVirtToPhysReg` is very simple: it just updates the `PhysRegState` mapping. Finally,<br/>
            `reloadVirtReg` updates the `UsedInInstr` map.
          </p>
          <p>
            The third scan operates on physical and virtual registers that are Defs. If the register is a physical register, it does `definePhysReg` with `regReserved` unless `MO.isDead()`, in which case it's regFree. `definePhysReg` is very simple: it just puts the register in the state that was requested (`regReserved` or `regFree`, in this case).
          </p>
          <p>
            To think about the problem, if we have,
          </p>
          <pre><code class="language-cpp">%RAX<def> = COPY %vreg342</code></pre>
          <p>
            we should always `regReserve` `%RAX`, right? Except if `%RAX` is dead. What<br/>
            about if it's an `&lt;imp-def&gt;`?
          </p>
          <pre><code class="language-cpp">CQO %RAX<imp-def>, %RDX<imp-def>, %RAX<imp-use></code></pre>
          <p>
            We didn't pass `CQO` `%RAX` explicitly, but that doesn't mean that a later instruction (for instance, `IDIV`) is not relying on this register's value. If we have an instruction between `CQO` and `IDIV`, that can potentially clobber `%RAX`, leading to a regalloc crash. Hence, we `regReserve` even if `MO.isImplicit()`.
          </p>
          <p>
            The third scan does `defineVirtReg` on virtual registers, to grab the first free physical register for the virtual register.
          </p>
          <p>
            Note: the "pretty-prints" are generated by setting a breakpoint in `AllocateBasicBlock` and executing `p MBB-&gt;dump()`.
          </p>
        </article>
      </main>
      <nav>
        <ul>
          <li>
            <a href="/index">index</a>
          </li>
          <li>
            <a href="/HoTT">HoTT</a>
          </li>
          <li>
            <a href="/ag">ag</a>
          </li>
          <li>
            <a href="/algebra">algebra</a>
          </li>
          <li>
            <a href="/at">at</a>
          </li>
          <li>
            <a href="/attic">attic</a>
          </li>
          <li>
            <a href="/category">category</a>
          </li>
          <li>
            <a href="/notes">notes</a>
          </li>
          <li>
            <a href="/topoi">topoi</a>
          </li>
        </ul>
      </nav>
    </div>
  </body>
</html>