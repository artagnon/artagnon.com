<!DOCTYPE html><html lang="en">
  <head>
    <title>An ABI-mismatch bug | artagnon.com</title>
    <meta charset="utf-8">
    <meta name="description" content="Ramkumar Ramachandra&#39;s personal website">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index,follow">
    <link rel="icon" href="/dist/artagnon.com.svg">
    <link rel="stylesheet" href="/dist/style.min.css">
    <script defer="" src="//cdnjs.cloudflare.com/ajax/libs/cash/6.0.1/cash.min.js"></script>
    <script defer="" src="//cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.35/dayjs.min.js"></script>
    <script defer="" src="//cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.35/plugin/relativeTime.min.js"></script>
    <script defer="" src="/dist/script.min.js"></script>
  <style id="MJX-CHTML-styles">
mjx-container[jax="CHTML"] {
  line-height: 0;
}

mjx-container [space="1"] {
  margin-left: .111em;
}

mjx-container [space="2"] {
  margin-left: .167em;
}

mjx-container [space="3"] {
  margin-left: .222em;
}

mjx-container [space="4"] {
  margin-left: .278em;
}

mjx-container [space="5"] {
  margin-left: .333em;
}

mjx-container [rspace="1"] {
  margin-right: .111em;
}

mjx-container [rspace="2"] {
  margin-right: .167em;
}

mjx-container [rspace="3"] {
  margin-right: .222em;
}

mjx-container [rspace="4"] {
  margin-right: .278em;
}

mjx-container [rspace="5"] {
  margin-right: .333em;
}

mjx-container [size="s"] {
  font-size: 70.7%;
}

mjx-container [size="ss"] {
  font-size: 50%;
}

mjx-container [size="Tn"] {
  font-size: 60%;
}

mjx-container [size="sm"] {
  font-size: 85%;
}

mjx-container [size="lg"] {
  font-size: 120%;
}

mjx-container [size="Lg"] {
  font-size: 144%;
}

mjx-container [size="LG"] {
  font-size: 173%;
}

mjx-container [size="hg"] {
  font-size: 207%;
}

mjx-container [size="HG"] {
  font-size: 249%;
}

mjx-container [width="full"] {
  width: 100%;
}

mjx-box {
  display: inline-block;
}

mjx-block {
  display: block;
}

mjx-itable {
  display: inline-table;
}

mjx-row {
  display: table-row;
}

mjx-row > * {
  display: table-cell;
}

mjx-mtext {
  display: inline-block;
}

mjx-mstyle {
  display: inline-block;
}

mjx-merror {
  display: inline-block;
  color: red;
  background-color: yellow;
}

mjx-mphantom {
  visibility: hidden;
}

_::-webkit-full-page-media, _:future, :root mjx-container {
  will-change: opacity;
}

mjx-c::before {
  display: block;
  width: 0;
}

.MJX-TEX {
  font-family: MJXZERO, MJXTEX;
}

.TEX-B {
  font-family: MJXZERO, MJXTEX-B;
}

.TEX-I {
  font-family: MJXZERO, MJXTEX-I;
}

.TEX-MI {
  font-family: MJXZERO, MJXTEX-MI;
}

.TEX-BI {
  font-family: MJXZERO, MJXTEX-BI;
}

.TEX-S1 {
  font-family: MJXZERO, MJXTEX-S1;
}

.TEX-S2 {
  font-family: MJXZERO, MJXTEX-S2;
}

.TEX-S3 {
  font-family: MJXZERO, MJXTEX-S3;
}

.TEX-S4 {
  font-family: MJXZERO, MJXTEX-S4;
}

.TEX-A {
  font-family: MJXZERO, MJXTEX-A;
}

.TEX-C {
  font-family: MJXZERO, MJXTEX-C;
}

.TEX-CB {
  font-family: MJXZERO, MJXTEX-CB;
}

.TEX-FR {
  font-family: MJXZERO, MJXTEX-FR;
}

.TEX-FRB {
  font-family: MJXZERO, MJXTEX-FRB;
}

.TEX-SS {
  font-family: MJXZERO, MJXTEX-SS;
}

.TEX-SSB {
  font-family: MJXZERO, MJXTEX-SSB;
}

.TEX-SSI {
  font-family: MJXZERO, MJXTEX-SSI;
}

.TEX-SC {
  font-family: MJXZERO, MJXTEX-SC;
}

.TEX-T {
  font-family: MJXZERO, MJXTEX-T;
}

.TEX-V {
  font-family: MJXZERO, MJXTEX-V;
}

.TEX-VB {
  font-family: MJXZERO, MJXTEX-VB;
}

mjx-stretchy-v mjx-c, mjx-stretchy-h mjx-c {
  font-family: MJXZERO, MJXTEX-S1, MJXTEX-S4, MJXTEX, MJXTEX-A ! important;
}

@font-face /* 0 */ {
  font-family: MJXZERO;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Zero.woff") format("woff");
}

@font-face /* 1 */ {
  font-family: MJXTEX;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Regular.woff") format("woff");
}

@font-face /* 2 */ {
  font-family: MJXTEX-B;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Bold.woff") format("woff");
}

@font-face /* 3 */ {
  font-family: MJXTEX-I;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Math-Italic.woff") format("woff");
}

@font-face /* 4 */ {
  font-family: MJXTEX-MI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Italic.woff") format("woff");
}

@font-face /* 5 */ {
  font-family: MJXTEX-BI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Math-BoldItalic.woff") format("woff");
}

@font-face /* 6 */ {
  font-family: MJXTEX-S1;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size1-Regular.woff") format("woff");
}

@font-face /* 7 */ {
  font-family: MJXTEX-S2;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size2-Regular.woff") format("woff");
}

@font-face /* 8 */ {
  font-family: MJXTEX-S3;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size3-Regular.woff") format("woff");
}

@font-face /* 9 */ {
  font-family: MJXTEX-S4;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size4-Regular.woff") format("woff");
}

@font-face /* 10 */ {
  font-family: MJXTEX-A;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_AMS-Regular.woff") format("woff");
}

@font-face /* 11 */ {
  font-family: MJXTEX-C;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Regular.woff") format("woff");
}

@font-face /* 12 */ {
  font-family: MJXTEX-CB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Bold.woff") format("woff");
}

@font-face /* 13 */ {
  font-family: MJXTEX-FR;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Fraktur-Regular.woff") format("woff");
}

@font-face /* 14 */ {
  font-family: MJXTEX-FRB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Fraktur-Bold.woff") format("woff");
}

@font-face /* 15 */ {
  font-family: MJXTEX-SS;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Regular.woff") format("woff");
}

@font-face /* 16 */ {
  font-family: MJXTEX-SSB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Bold.woff") format("woff");
}

@font-face /* 17 */ {
  font-family: MJXTEX-SSI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Italic.woff") format("woff");
}

@font-face /* 18 */ {
  font-family: MJXTEX-SC;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Script-Regular.woff") format("woff");
}

@font-face /* 19 */ {
  font-family: MJXTEX-T;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Typewriter-Regular.woff") format("woff");
}

@font-face /* 20 */ {
  font-family: MJXTEX-V;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Vector-Regular.woff") format("woff");
}

@font-face /* 21 */ {
  font-family: MJXTEX-VB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Vector-Bold.woff") format("woff");
}
</style></head>
  <body class="wrapper">
    <nav><a href="/"><img id="logo" src="/dist/artagnon.com.svg" alt="home" width="317" height="390"></a><img id="more" src="/dist/icon.more.svg" alt="menu" width="16" height="74">
      <ul>
        <li>
          <span class="navidx">01</span><a href="/art">art</a>
        </li>
        <li>
          <span class="navidx">02</span><a href="/computing">computing</a>
        </li>
        <li>
          <span class="navidx">03</span><a href="/logic">logic</a>
        </li>
        <li>
          <span class="navidx">04</span><a href="/math">math</a>
        </li>
      </ul>
    </nav>
    <main>
      <header>
        <h1>
          An ABI-mismatch bug
        </h1>
        <div id="metadata">
          <span id="timestamp"><time class="begin" datetime="2015-08-23">Sun, 23 Aug 2015 16:00:00 -0500</time><span class="to"><img src="/dist/icon.arrow.svg" alt="arrow" width="40" height="82"></span><time class="end" datetime="2021-02-21">Sun, 21 Feb 2021 15:00:00 +0100</time></span><br><span id="locations">Boston<span class="to"><img src="/dist/icon.arrow.svg" alt="arrow" width="40" height="82"></span>Chennai<span class="to"><img src="/dist/icon.arrow.svg" alt="arrow" width="40" height="82"></span>Paris</span>
        </div>
      </header>
      <article>
        <p>
          Our custom max function returns the maximum of two positive integers, and returns the negative integer, given a positive and negative integer. Classic signed wrapping, you'd think. It's not so simple, as the problem reproduces only under the following circumstances:
        </p>
        <ol class="olitems" type="none" start="1">
          <li>
            LLVM code is calling the max function.
          </li>
          <li>
            The library containing the max function is compiled without debugging information.
          </li>
          <li>
            The entire world has been built with XCode 6+.
          </li>
        </ol>
        <p>
          More information: The LLVM IR is exactly the same between an XCode 5 sandbox, an XCode 6 sandbox, and a GNU/Linux sandbox. The corresponding assembly diff is also clean.
        </p>
        <p>
          The corresponding C++ code (is actually specialized with short) is:
        </p>
        <style>
          .highlight table td { padding: 5px; }
          .highlight table pre { margin: 0; }
          .highlight, .highlight .w {
            color: #586e75;
          }
          .highlight .err {
            color: #002b36;
            background-color: #dc322f;
          }
          .highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
            color: #657b83;
          }
          .highlight .cp {
            color: #b58900;
          }
          .highlight .nt {
            color: #b58900;
          }
          .highlight .o, .highlight .ow {
            color: #93a1a1;
          }
          .highlight .p, .highlight .pi {
            color: #93a1a1;
          }
          .highlight .gi {
            color: #859900;
          }
          .highlight .gd {
            color: #dc322f;
          }
          .highlight .gh {
            color: #268bd2;
            background-color: #002b36;
            font-weight: bold;
          }
          .highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
            color: #6c71c4;
          }
          .highlight .kc {
            color: #cb4b16;
          }
          .highlight .kt {
            color: #cb4b16;
          }
          .highlight .kd {
            color: #cb4b16;
          }
          .highlight .s, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
            color: #859900;
          }
          .highlight .sa {
            color: #6c71c4;
          }
          .highlight .sr {
            color: #2aa198;
          }
          .highlight .si {
            color: #d33682;
          }
          .highlight .se {
            color: #d33682;
          }
          .highlight .nn {
            color: #b58900;
          }
          .highlight .nc {
            color: #b58900;
          }
          .highlight .no {
            color: #b58900;
          }
          .highlight .na {
            color: #268bd2;
          }
          .highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
            color: #859900;
          }
          .highlight .ss {
            color: #859900;
          }
        </style>
        <pre><code class="highlight"><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">FORCEINLINE</span> <span class="n">T</span> <span class="nf">operator</span><span class="p">()(</span><span class="n">T</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="n">b</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="n">b</span> <span class="o">?</span> <span class="n">a</span> <span class="o">:</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span></code></pre>
        <p>
          While in lldb, the assembly instructions look like:
        </p>
        <style>
          .highlight table td { padding: 5px; }
          .highlight table pre { margin: 0; }
          .highlight, .highlight .w {
            color: #586e75;
          }
          .highlight .err {
            color: #002b36;
            background-color: #dc322f;
          }
          .highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
            color: #657b83;
          }
          .highlight .cp {
            color: #b58900;
          }
          .highlight .nt {
            color: #b58900;
          }
          .highlight .o, .highlight .ow {
            color: #93a1a1;
          }
          .highlight .p, .highlight .pi {
            color: #93a1a1;
          }
          .highlight .gi {
            color: #859900;
          }
          .highlight .gd {
            color: #dc322f;
          }
          .highlight .gh {
            color: #268bd2;
            background-color: #002b36;
            font-weight: bold;
          }
          .highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
            color: #6c71c4;
          }
          .highlight .kc {
            color: #cb4b16;
          }
          .highlight .kt {
            color: #cb4b16;
          }
          .highlight .kd {
            color: #cb4b16;
          }
          .highlight .s, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
            color: #859900;
          }
          .highlight .sa {
            color: #6c71c4;
          }
          .highlight .sr {
            color: #2aa198;
          }
          .highlight .si {
            color: #d33682;
          }
          .highlight .se {
            color: #d33682;
          }
          .highlight .nn {
            color: #b58900;
          }
          .highlight .nc {
            color: #b58900;
          }
          .highlight .no {
            color: #b58900;
          }
          .highlight .na {
            color: #268bd2;
          }
          .highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
            color: #859900;
          }
          .highlight .ss {
            color: #859900;
          }
        </style>
        <pre><code class="highlight"><span class="o">---------------</span> <span class="p">[</span><span class="n">XCode</span> <span class="mi">5</span><span class="p">]</span>
<span class="o">-&gt;</span> <span class="mh">0x108af1930</span><span class="o">:</span>  <span class="n">pushq</span>  <span class="o">%</span><span class="n">rbp</span>
   <span class="mh">0x108af1931</span><span class="o">:</span>  <span class="n">movq</span>   <span class="o">%</span><span class="n">rsp</span><span class="p">,</span> <span class="o">%</span><span class="n">rbp</span>
   <span class="mh">0x108af1934</span><span class="o">:</span>  <span class="n">cmpw</span>   <span class="o">%</span><span class="n">si</span><span class="p">,</span> <span class="o">%</span><span class="n">di</span>
   <span class="mh">0x108af1937</span><span class="o">:</span>  <span class="n">cmovgew</span> <span class="o">%</span><span class="n">di</span><span class="p">,</span> <span class="o">%</span><span class="n">si</span>
   <span class="mh">0x108af193b</span><span class="o">:</span>  <span class="n">movswl</span> <span class="o">%</span><span class="n">si</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
   <span class="mh">0x108af193e</span><span class="o">:</span>  <span class="n">popq</span>   <span class="o">%</span><span class="n">rbp</span>
   <span class="mh">0x108af193f</span><span class="o">:</span>  <span class="n">retq</span></code></pre>
        <style>
          .highlight table td { padding: 5px; }
          .highlight table pre { margin: 0; }
          .highlight, .highlight .w {
            color: #586e75;
          }
          .highlight .err {
            color: #002b36;
            background-color: #dc322f;
          }
          .highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
            color: #657b83;
          }
          .highlight .cp {
            color: #b58900;
          }
          .highlight .nt {
            color: #b58900;
          }
          .highlight .o, .highlight .ow {
            color: #93a1a1;
          }
          .highlight .p, .highlight .pi {
            color: #93a1a1;
          }
          .highlight .gi {
            color: #859900;
          }
          .highlight .gd {
            color: #dc322f;
          }
          .highlight .gh {
            color: #268bd2;
            background-color: #002b36;
            font-weight: bold;
          }
          .highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
            color: #6c71c4;
          }
          .highlight .kc {
            color: #cb4b16;
          }
          .highlight .kt {
            color: #cb4b16;
          }
          .highlight .kd {
            color: #cb4b16;
          }
          .highlight .s, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
            color: #859900;
          }
          .highlight .sa {
            color: #6c71c4;
          }
          .highlight .sr {
            color: #2aa198;
          }
          .highlight .si {
            color: #d33682;
          }
          .highlight .se {
            color: #d33682;
          }
          .highlight .nn {
            color: #b58900;
          }
          .highlight .nc {
            color: #b58900;
          }
          .highlight .no {
            color: #b58900;
          }
          .highlight .na {
            color: #268bd2;
          }
          .highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
            color: #859900;
          }
          .highlight .ss {
            color: #859900;
          }
        </style>
        <pre><code class="highlight"><span class="o">---------------</span> <span class="p">[</span><span class="n">XCode</span> <span class="mi">6</span><span class="p">]</span>
<span class="o">-&gt;</span> <span class="mh">0x108d1ac10</span><span class="o">:</span>  <span class="n">pushq</span>  <span class="o">%</span><span class="n">rbp</span>
   <span class="mh">0x108d1ac11</span><span class="o">:</span>  <span class="n">movq</span>   <span class="o">%</span><span class="n">rsp</span><span class="p">,</span> <span class="o">%</span><span class="n">rbp</span>
   <span class="mh">0x108d1ac14</span><span class="o">:</span>  <span class="n">cmpl</span>   <span class="o">%</span><span class="n">esi</span><span class="p">,</span> <span class="o">%</span><span class="n">edi</span>
   <span class="mh">0x108d1ac16</span><span class="o">:</span>  <span class="n">cmovgew</span> <span class="o">%</span><span class="n">di</span><span class="p">,</span> <span class="o">%</span><span class="n">si</span>
   <span class="mh">0x108d1ac1a</span><span class="o">:</span>  <span class="n">movswl</span> <span class="o">%</span><span class="n">si</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
   <span class="mh">0x108d1ac1d</span><span class="o">:</span>  <span class="n">popq</span>   <span class="o">%</span><span class="n">rbp</span>
   <span class="mh">0x108d1ac1e</span><span class="o">:</span>  <span class="n">retq</span></code></pre>
        <p>
          So, it's comparing the extended registers, but cmpl/cmpw difference is
          messing up somehow.
        </p>
        <p>
          After execution of the cmpl/cmpw:
        </p>
        <style>
          .highlight table td { padding: 5px; }
          .highlight table pre { margin: 0; }
          .highlight, .highlight .w {
            color: #586e75;
          }
          .highlight .err {
            color: #002b36;
            background-color: #dc322f;
          }
          .highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
            color: #657b83;
          }
          .highlight .cp {
            color: #b58900;
          }
          .highlight .nt {
            color: #b58900;
          }
          .highlight .o, .highlight .ow {
            color: #93a1a1;
          }
          .highlight .p, .highlight .pi {
            color: #93a1a1;
          }
          .highlight .gi {
            color: #859900;
          }
          .highlight .gd {
            color: #dc322f;
          }
          .highlight .gh {
            color: #268bd2;
            background-color: #002b36;
            font-weight: bold;
          }
          .highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
            color: #6c71c4;
          }
          .highlight .kc {
            color: #cb4b16;
          }
          .highlight .kt {
            color: #cb4b16;
          }
          .highlight .kd {
            color: #cb4b16;
          }
          .highlight .s, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
            color: #859900;
          }
          .highlight .sa {
            color: #6c71c4;
          }
          .highlight .sr {
            color: #2aa198;
          }
          .highlight .si {
            color: #d33682;
          }
          .highlight .se {
            color: #d33682;
          }
          .highlight .nn {
            color: #b58900;
          }
          .highlight .nc {
            color: #b58900;
          }
          .highlight .no {
            color: #b58900;
          }
          .highlight .na {
            color: #268bd2;
          }
          .highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
            color: #859900;
          }
          .highlight .ss {
            color: #859900;
          }
        </style>
        <pre><code class="highlight"><span class="o">---------------</span> <span class="p">[</span><span class="n">XCode</span> <span class="mi">5</span><span class="p">]</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">di</span>
      <span class="n">di</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">48</span><span class="p">}</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">si</span>
      <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="mi">34</span><span class="p">}</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">edi</span>
     <span class="n">edi</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">48</span> <span class="mi">7103</span><span class="p">}</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">esi</span>
     <span class="n">esi</span> <span class="o">=</span> <span class="p">{</span><span class="mi">34</span> <span class="mi">7103</span><span class="p">}</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="n">b</span> <span class="n">rflags</span>
  <span class="n">rflags</span> <span class="o">=</span> <span class="mb">0b0000000000000000000000000000000000000000000000000000001010010010</span></code></pre>
        <style>
          .highlight table td { padding: 5px; }
          .highlight table pre { margin: 0; }
          .highlight, .highlight .w {
            color: #586e75;
          }
          .highlight .err {
            color: #002b36;
            background-color: #dc322f;
          }
          .highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
            color: #657b83;
          }
          .highlight .cp {
            color: #b58900;
          }
          .highlight .nt {
            color: #b58900;
          }
          .highlight .o, .highlight .ow {
            color: #93a1a1;
          }
          .highlight .p, .highlight .pi {
            color: #93a1a1;
          }
          .highlight .gi {
            color: #859900;
          }
          .highlight .gd {
            color: #dc322f;
          }
          .highlight .gh {
            color: #268bd2;
            background-color: #002b36;
            font-weight: bold;
          }
          .highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
            color: #6c71c4;
          }
          .highlight .kc {
            color: #cb4b16;
          }
          .highlight .kt {
            color: #cb4b16;
          }
          .highlight .kd {
            color: #cb4b16;
          }
          .highlight .s, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
            color: #859900;
          }
          .highlight .sa {
            color: #6c71c4;
          }
          .highlight .sr {
            color: #2aa198;
          }
          .highlight .si {
            color: #d33682;
          }
          .highlight .se {
            color: #d33682;
          }
          .highlight .nn {
            color: #b58900;
          }
          .highlight .nc {
            color: #b58900;
          }
          .highlight .no {
            color: #b58900;
          }
          .highlight .na {
            color: #268bd2;
          }
          .highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
            color: #859900;
          }
          .highlight .ss {
            color: #859900;
          }
        </style>
        <pre><code class="highlight"><span class="o">---------------</span> <span class="p">[</span><span class="n">XCode</span> <span class="mi">6</span><span class="p">]</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">di</span>
      <span class="n">di</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">48</span><span class="p">}</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">si</span>
      <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="mi">34</span><span class="p">}</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">edi</span>
     <span class="n">edi</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">48</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">esi</span>
     <span class="n">esi</span> <span class="o">=</span> <span class="p">{</span><span class="mi">34</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="n">b</span> <span class="n">rflags</span>
  <span class="n">rflags</span> <span class="o">=</span> <span class="mb">0b0000000000000000000000000000000000000000000000000000001000010010</span>
                                                                     <span class="o">^</span>
                                                             <span class="n">Sign</span> <span class="n">flag</span> <span class="n">different</span></code></pre>
        <style>
          .highlight table td { padding: 5px; }
          .highlight table pre { margin: 0; }
          .highlight, .highlight .w {
            color: #586e75;
          }
          .highlight .err {
            color: #002b36;
            background-color: #dc322f;
          }
          .highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
            color: #657b83;
          }
          .highlight .cp {
            color: #b58900;
          }
          .highlight .nt {
            color: #b58900;
          }
          .highlight .o, .highlight .ow {
            color: #93a1a1;
          }
          .highlight .p, .highlight .pi {
            color: #93a1a1;
          }
          .highlight .gi {
            color: #859900;
          }
          .highlight .gd {
            color: #dc322f;
          }
          .highlight .gh {
            color: #268bd2;
            background-color: #002b36;
            font-weight: bold;
          }
          .highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
            color: #6c71c4;
          }
          .highlight .kc {
            color: #cb4b16;
          }
          .highlight .kt {
            color: #cb4b16;
          }
          .highlight .kd {
            color: #cb4b16;
          }
          .highlight .s, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
            color: #859900;
          }
          .highlight .sa {
            color: #6c71c4;
          }
          .highlight .sr {
            color: #2aa198;
          }
          .highlight .si {
            color: #d33682;
          }
          .highlight .se {
            color: #d33682;
          }
          .highlight .nn {
            color: #b58900;
          }
          .highlight .nc {
            color: #b58900;
          }
          .highlight .no {
            color: #b58900;
          }
          .highlight .na {
            color: #268bd2;
          }
          .highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
            color: #859900;
          }
          .highlight .ss {
            color: #859900;
          }
        </style>
        <pre><code class="highlight"><span class="o">---------------</span> <span class="p">[</span><span class="n">XCode</span> <span class="mi">6</span><span class="p">,</span> <span class="n">with</span> <span class="n">C</span> <span class="n">code</span> <span class="n">calling</span> <span class="n">max</span><span class="p">]</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">di</span>
      <span class="n">di</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">48</span><span class="p">}</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">si</span>
      <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="mi">34</span><span class="p">}</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">edi</span>
     <span class="n">edi</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">48</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
                 <span class="o">^</span>
         <span class="n">In</span> <span class="n">the</span> <span class="n">LLVM</span> <span class="n">call</span><span class="p">,</span> <span class="k">this</span> <span class="n">is</span> <span class="n">zero</span>
<span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">read</span> <span class="o">--</span><span class="n">format</span> <span class="kt">int16_t</span><span class="p">[]</span> <span class="n">esi</span>
     <span class="n">esi</span> <span class="o">=</span> <span class="p">{</span><span class="mi">34</span> <span class="mi">0</span><span class="p">}</span></code></pre>
        <p>
          In conclusion, this is a Clang/LLVM version mismatch. It's compiling muIntScalarMax_sint16 to emit a compl instead of a compw. The fact that the bug only reproduces with LLVM is because: LLVM doesn't set up the extended form of the register correctly for negative numbers, when calling a function with a word-sized register.
        </p>
        <p>
          The SysV ABI does not guarantee that the i16 will be sext'ed to i32. Clang ABI is probably an enhancement over the SysV ABI, and LLVM 3.5 doesn't know about this.
        </p>
      </article>
    </main>
  </body>
</html>